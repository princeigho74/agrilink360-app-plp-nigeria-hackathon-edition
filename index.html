<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriLink360 — Improved Demo</title>

  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body,#root { height: 100%; }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    /* small utility for visually-hidden text for accessibility */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Payment libs -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://checkout.flutterwave.com/v3.js"></script>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /******************************
   * Utility helpers
   ******************************/
  function uid(prefix='id') {
    return prefix + '_' + Math.random().toString(36).slice(2,9);
  }

  function currencyFmt(n){ return new Intl.NumberFormat('en-NG', { style:'currency', currency:'NGN' }).format(n); }

  // localStorage helpers
  const storage = {
    load(key, fallback) {
      try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
      catch { return fallback; }
    },
    save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
  };

  /******************************
   * Default demo data
   ******************************/
  const DEFAULT_PRODUCTS = [
    { id: uid('p'), title: 'Yellow Maize (100kg)', qty: '100kg', location: 'Lagos', price: 50000, desc: 'Freshly harvested yellow maize.', farmerId: 'demo_farmer', images: [], sensor: { temp: 28, humidity: 70 } },
    { id: uid('p'), title: 'Ripe Tomatoes (200kg)', qty: '200kg', location: 'Abuja', price: 35000, desc: 'Juicy farm tomatoes, morning harvest.', farmerId: 'ngozi_farm', images: [], sensor: { temp: 26, humidity: 78 } },
    { id: uid('p'), title: 'White Beans (150kg)', qty: '150kg', location: 'Kano', price: 42000, desc: 'Protein rich beans.', farmerId: 'ade_agro', images: [], sensor: { temp: 27, humidity: 65 } }
  ];

  const DEFAULT_USERS = [
    { id: 'demo_farmer', type: 'farmer', name: 'Uche Farms', email: 'uche@demo.com', password: 'farm123' },
    { id: 'buyer_demo', type: 'buyer', name: 'Market Buyer', email: 'buyer@demo.com', password: 'buy123' }
  ];

  /******************************
   * Payment functions (demo)
   * - Replace keys with your own
   * - Do server-side verification in production
   ******************************/
  function payWithPaystack(amountNGN, email, onSuccess, onFailure){
    try {
      const handler = PaystackPop.setup({
        key: 'pk_test_xxxxxxxxxxxxxxxxxxxxx', // TODO -> replace with your Paystack public key
        email: email || 'buyer@example.com',
        amount: amountNGN * 100, // in kobo
        currency: 'NGN',
        callback: function(response){
          // IMPORTANT: In production call your backend to verify reference before trusting it
          onSuccess && onSuccess(response);
        },
        onClose: function(){ onFailure && onFailure({ cancelled: true }); }
      });
      handler.openIframe();
    } catch(err){
      alert('Paystack not available: ' + err.message);
    }
  }

  function payWithFlutterwave(amountNGN, email, onSuccess, onFailure){
    try {
      FlutterwaveCheckout({
        public_key: "FLWPUBK_TEST-xxxxxxxxxxxxxxxxxxxxx-X", // TODO -> replace with your Flutterwave public key
        tx_ref: 'agri_' + Date.now(),
        amount: amountNGN,
        currency: "NGN",
        payment_options: "card,ussd,banktransfer",
        customer: { email: email || 'buyer@example.com', phone_number: "08012345678", name: "Agri Buyer" },
        callback: function(data){ onSuccess && onSuccess(data); },
        onclose: function(){ onFailure && onFailure({ cancelled:true }); }
      });
    } catch(err) {
      alert('Flutterwave checkout not available: ' + err.message);
    }
  }

  /******************************
   * Toast (global notifications)
   ******************************/
  function Toast({ items, remove }) {
    return (
      <div className="fixed right-4 bottom-4 w-96 space-y-2 z-50">
        {items.map(t => (
          <div key={t.id} className="bg-white shadow p-3 rounded border-l-4" role="status" aria-live="polite">
            <div className="flex items-start justify-between">
              <div>
                <div className="font-semibold">{t.title}</div>
                <div className="text-xs text-gray-600">{t.msg}</div>
              </div>
              <div className="ml-3">
                <button aria-label="close" onClick={() => remove(t.id)} className="text-sm text-gray-500 px-2 py-1">✕</button>
              </div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  /******************************
   * Header / Nav
   ******************************/
  function Header({ current, setCurrent, user, signout }) {
    return (
      <header className="bg-white shadow sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center space-x-3">
              <div className="w-10 h-10 rounded-md bg-green-600 text-white flex items-center justify-center font-bold">A</div>
              <div>
                <div className="text-lg font-semibold">AgriLink360</div>
                <div className="text-xs text-gray-500">From Farm to Table</div>
              </div>
            </div>

            <nav className="flex items-center space-x-3">
              <button className={`px-3 py-2 rounded ${current==='market'?'bg-green-50':''}`} onClick={()=>setCurrent('market')}>Marketplace</button>
              <button className={`px-3 py-2 rounded ${current==='iot'?'bg-green-50':''}`} onClick={()=>setCurrent('iot')}>IoT Monitor</button>
              <button className={`px-3 py-2 rounded ${current==='dashboard'?'bg-green-50':''}`} onClick={()=>setCurrent('dashboard')}>Dashboard</button>
              {user ? (
                <div className="flex items-center gap-2">
                  <div className="text-sm text-gray-700">{user.name}</div>
                  <button onClick={signout} className="px-3 py-1 border rounded text-sm">Sign out</button>
                </div>
              ) : (
                <div className="flex gap-2">
                  <button onClick={()=>setCurrent('auth')} className="px-3 py-1 border rounded text-sm">Sign in / Register</button>
                </div>
              )}
            </nav>
          </div>
        </div>
      </header>
    );
  }

  /******************************
   * Auth component (simple demo)
   ******************************/
  function Auth({ onLogin }) {
    const [mode, setMode] = useState('login'); // login | register
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [pw, setPw] = useState('');
    const [type, setType] = useState('farmer'); // farmer or buyer

    function register(e){
      e.preventDefault();
      const users = storage.load('users', DEFAULT_USERS);
      // simple validation
      if(!name || !email || !pw){ alert('Please fill all fields'); return; }
      const id = uid(type);
      users.push({ id, type, name, email, password: pw });
      storage.save('users', users);
      onLogin({ id, name, email, type});
    }
    function login(e){
      e.preventDefault();
      const users = storage.load('users', DEFAULT_USERS);
      const u = users.find(x => x.email === email && x.password === pw);
      if(!u){ alert('Invalid credentials (demo)'); return; }
      onLogin(u);
    }

    return (
      <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded shadow">
        <h3 className="text-lg font-semibold mb-4">{mode==='login' ? 'Sign In' : 'Register'}</h3>
        <form onSubmit={mode==='login'?login:register} className="space-y-3">
          {mode==='register' && (
            <>
              <label className="block">
                <div className="text-xs text-gray-600">Name</div>
                <input value={name} onChange={e=>setName(e.target.value)} className="w-full p-2 border rounded" />
              </label>
              <label className="block">
                <div className="text-xs text-gray-600">Account type</div>
                <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-2 border rounded">
                  <option value="farmer">Farmer</option>
                  <option value="buyer">Buyer</option>
                </select>
              </label>
            </>
          )}
          <label className="block">
            <div className="text-xs text-gray-600">Email</div>
            <input value={email} onChange={e=>setEmail(e.target.value)} type="email" className="w-full p-2 border rounded" />
          </label>
          <label className="block">
            <div className="text-xs text-gray-600">Password</div>
            <input value={pw} onChange={e=>setPw(e.target.value)} type="password" className="w-full p-2 border rounded" />
          </label>
          <div className="flex justify-between items-center">
            <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded">{mode==='login' ? 'Sign In' : 'Create Account'}</button>
            <button type="button" className="text-sm text-gray-600 underline" onClick={()=>setMode(mode==='login'?'register':'login')}>{mode==='login' ? 'Need an account?' : 'Have an account?'}</button>
          </div>
        </form>
        <div className="text-xs text-gray-500 mt-3">Demo accounts: farmer(uche@demo.com / farm123), buyer(buyer@demo.com / buy123)</div>
      </div>
    );
  }

  /******************************
   * Marketplace (Buyer view)
   ******************************/
  function Marketplace({ products, onBuy, onView, query, setQuery, filters, setFilters }) {
    // simple filtered list
    const filtered = products.filter(p => {
      const q = query.trim().toLowerCase();
      const matchesQuery = q === '' || p.title.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q) || p.location.toLowerCase().includes(q);
      const byLocation = !filters.location || p.location.toLowerCase() === filters.location.toLowerCase();
      return matchesQuery && byLocation;
    });

    return (
      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-2xl font-semibold">Marketplace</h2>
          <div className="flex gap-2">
            <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search products, location or description" className="px-3 py-2 border rounded w-80" />
            <select value={filters.location||''} onChange={e=>setFilters(f=>({ ...f, location: e.target.value }))} className="px-3 py-2 border rounded">
              <option value="">All locations</option>
              {[...new Set(products.map(p=>p.location))].map(loc => <option key={loc} value={loc}>{loc}</option>)}
            </select>
          </div>
        </div>

        <div className="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
          {filtered.map(p => (
            <div key={p.id} className={`bg-white rounded shadow overflow-hidden ${p.spoilage?'ring-4 ring-red-100':''}`}>
              <div className="p-4">
                <div className="flex items-start justify-between">
                  <div>
                    <h3 className="font-semibold">{p.title}</h3>
                    <div className="text-xs text-gray-500">{p.qty} • {p.location}</div>
                  </div>
                  {p.spoilage && <div className="text-sm text-red-600 font-semibold">⚠️ Spoilage risk</div>}
                </div>
                <p className="text-sm text-gray-700 mt-2">{p.desc}</p>
                <div className="mt-3 flex items-center justify-between">
                  <div className="text-lg font-bold">{currencyFmt(p.price)}</div>
                  <div className="flex gap-2">
                    <button onClick={()=>onView(p)} className="px-3 py-1 border rounded text-sm">Details</button>
                    <button onClick={()=>onBuy(p)} className="px-3 py-1 bg-green-600 text-white rounded text-sm">Buy</button>
                  </div>
                </div>
              </div>
            </div>
          ))}
          {filtered.length === 0 && <div className="col-span-full text-center text-gray-500 p-8 bg-white rounded">No products found</div>}
        </div>
      </div>
    );
  }

  /******************************
   * Product form (Farmer add)
   ******************************/
  function ProductForm({ onAdd, farmer }) {
    const [title, setTitle] = useState('');
    const [qty, setQty] = useState('');
    const [location, setLocation] = useState('');
    const [price, setPrice] = useState('');
    const [desc, setDesc] = useState('');
    const [tempThreshold, setTempThreshold] = useState(30);
    const [humidityThreshold, setHumidityThreshold] = useState(80);

    function submit(e){
      e.preventDefault();
      if(!title || !qty || !location || !price){ alert('Please fill required fields'); return; }
      const newP = {
        id: uid('p'),
        title,
        qty,
        location,
        price: Number(price),
        desc,
        farmerId: farmer.id,
        sensor: { temp: Number(tempThreshold), humidity: Number(humidityThreshold) }
      };
      onAdd(newP);
      // clear
      setTitle(''); setQty(''); setLocation(''); setPrice(''); setDesc('');
    }

    return (
      <form onSubmit={submit} className="max-w-3xl bg-white p-4 rounded shadow space-y-3">
        <h3 className="text-lg font-semibold">Add / List Product</h3>
        <div>
          <label className="text-xs text-gray-600">Title</label>
          <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-2 border rounded" />
        </div>
        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs text-gray-600">Quantity (e.g. 100kg)</label>
            <input value={qty} onChange={e=>setQty(e.target.value)} className="w-full p-2 border rounded" />
          </div>
          <div>
            <label className="text-xs text-gray-600">Location</label>
            <input value={location} onChange={e=>setLocation(e.target.value)} className="w-full p-2 border rounded" />
          </div>
        </div>
        <div>
          <label className="text-xs text-gray-600">Price (NGN)</label>
          <input value={price} onChange={e=>setPrice(e.target.value)} type="number" className="w-full p-2 border rounded" />
        </div>
        <div>
          <label className="text-xs text-gray-600">Description</label>
          <textarea value={desc} onChange={e=>setDesc(e.target.value)} className="w-full p-2 border rounded" rows="3"></textarea>
        </div>
        <div className="grid grid-cols-2 gap-3">
          <div>
            <label className="text-xs text-gray-600">Temp threshold (°C)</label>
            <input value={tempThreshold} onChange={e=>setTempThreshold(e.target.value)} type="number" className="w-full p-2 border rounded" />
          </div>
          <div>
            <label className="text-xs text-gray-600">Humidity threshold (%)</label>
            <input value={humidityThreshold} onChange={e=>setHumidityThreshold(e.target.value)} type="number" className="w-full p-2 border rounded" />
          </div>
        </div>

        <div className="flex justify-end gap-2">
          <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded">Add Product</button>
        </div>
      </form>
    );
  }

  /******************************
   * Product detail modal
   ******************************/
  function ProductModal({ product, close, onBuy }) {
    if(!product) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
        <div className="bg-white rounded-lg max-w-2xl w-full p-6">
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-xl font-semibold">{product.title}</h3>
              <div className="text-xs text-gray-500">{product.qty} • {product.location}</div>
            </div>
            <button onClick={close} className="text-gray-500">✕</button>
          </div>
          <p className="mt-3 text-sm text-gray-700">{product.desc}</p>
          <div className="mt-4 flex justify-between items-center">
            <div className="text-2xl font-bold">{currencyFmt(product.price)}</div>
            <div className="flex gap-2">
              <button onClick={()=>onBuy(product)} className="px-3 py-2 bg-green-600 text-white rounded">Buy</button>
            </div>
          </div>
          <div className="mt-4 text-xs text-gray-500">Sensor thresholds — Temp: {product.sensor?.temp}°C • Humidity: {product.sensor?.humidity}%</div>
        </div>
      </div>
    );
  }

  /******************************
   * Dashboard (farmer's area + analytics)
   ******************************/
  function DashboardArea({ user, products, onAddProduct, onSimulateSensor, analytics }) {
    const myProducts = products.filter(p => p.farmerId === user.id);
    return (
      <div className="max-w-7xl mx-auto px-4 py-6 grid gap-6 lg:grid-cols-3">
        <div className="lg:col-span-2">
          <h2 className="text-2xl font-semibold mb-3">My Products</h2>
          <div className="space-y-3">
            {myProducts.length === 0 && <div className="text-gray-500 p-4 bg-white rounded">No products yet — add one below.</div>}
            {myProducts.map(p => (
              <div key={p.id} className={`bg-white p-3 rounded shadow ${p.spoilage?'ring-4 ring-red-100':''}`}>
                <div className="flex items-start justify-between">
                  <div>
                    <div className="font-semibold">{p.title}</div>
                    <div className="text-xs text-gray-500">{p.qty} • {p.location}</div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold">{currencyFmt(p.price)}</div>
                    {p.spoilage && <div className="text-red-600 text-sm">Spoilage risk</div>}
                  </div>
                </div>
                <div className="mt-2 text-sm text-gray-600">{p.desc}</div>
                <div className="mt-3 flex gap-2">
                  <button className="px-2 py-1 border rounded text-sm" onClick={()=>onSimulateSensor(p.id)}>Simulate Sensor</button>
                </div>
              </div>
            ))}
          </div>

          <div className="mt-6">
            <h3 className="text-lg font-semibold mb-2">Add new product</h3>
            <ProductForm onAdd={onAddProduct} farmer={user} />
          </div>
        </div>

        <aside className="bg-white rounded shadow p-4">
          <h3 className="font-semibold">Analytics</h3>
          <div className="text-sm text-gray-600 mt-2">
            <div>Products listed: <strong>{myProducts.length}</strong></div>
            <div>Platform views: <strong>{analytics.views}</strong></div>
            <div>Matches (demo): <strong>{analytics.matches}</strong></div>
            <div className="text-xs text-gray-400 mt-3">Tip: Use the IoT Monitor to test spoilage alerts.</div>
          </div>
        </aside>
      </div>
    );
  }

  /******************************
   * IoT Monitor page
   ******************************/
  function IoTMonitor({ products, updateSensorState, sendToast }) {
    const [running, setRunning] = useState(false);
    const [intervalMs, setIntervalMs] = useState(3000);
    const intervalRef = useRef(null);

    useEffect(()=> {
      if(running){
        intervalRef.current = setInterval(()=> {
          // randomly pick a product and update its sensor (simulated)
          const p = products[Math.floor(Math.random()*products.length)];
          if(!p) return;
          // jitter around current sensor values, simulate raising temp/humidity occasionally
          const tempJitter = (Math.random()*4 - 2); // -2..+2
          const humJitter = (Math.random()*6 - 3);
          const newTemp = Math.round(((p.sensor?.temp || 25) + tempJitter) * 10)/10;
          const newHum = Math.round(((p.sensor?.humidity || 70) + humJitter) * 10)/10;
          updateSensorState(p.id, { temp: newTemp, humidity: newHum });
          // detect spoilage risk
          if(newTemp >= (p.sensor?.temp || 30) || newHum >= (p.sensor?.humidity || 85)) {
            sendToast({ title: 'IoT Alert', msg: `${p.title} at ${p.location} flagged for spoilage risk (T:${newTemp}°C, H:${newHum}%).` });
          }
        }, intervalMs);
      }
      return ()=> clearInterval(intervalRef.current);
    }, [running, intervalMs, products]);

    return (
      <div className="max-w-6xl mx-auto px-4 py-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-2xl font-semibold">IoT Spoilage Monitor</h2>
          <div className="flex gap-2">
            <input type="number" value={intervalMs} onChange={e=>setIntervalMs(Number(e.target.value))} className="p-2 border rounded w-28" />
            <button onClick={()=>setRunning(r=>!r)} className="px-3 py-2 rounded bg-green-600 text-white">{running ? 'Stop' : 'Start'} Simulation</button>
          </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {products.map(p => (
            <div key={p.id} className={`bg-white p-4 rounded shadow ${p.spoilage ? 'border-l-4 border-red-400' : ''}`}>
              <div className="flex justify-between items-start">
                <div>
                  <div className="font-semibold">{p.title}</div>
                  <div className="text-xs text-gray-500">{p.location} • {p.qty}</div>
                </div>
                <div className="text-right">
                  <div className="text-sm">Temp: <strong>{p.sensor?.temp ?? '—'}°C</strong></div>
                  <div className="text-sm">Humidity: <strong>{p.sensor?.humidity ?? '—'}%</strong></div>
                </div>
              </div>
              <div className="mt-3 text-xs text-gray-500">Thresholds: Temp ≥ {p.sensor?.temp}°C or Humidity ≥ {p.sensor?.humidity}% triggers an alert.</div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  /******************************
   * Root App
   ******************************/
  function App(){
    // load persisted state or defaults
    const [products, setProducts] = useState(() => storage.load('products', DEFAULT_PRODUCTS));
    const [users, setUsers] = useState(() => storage.load('users', DEFAULT_USERS));
    const [orders, setOrders] = useState(() => storage.load('orders', []));
    const [analytics, setAnalytics] = useState(() => storage.load('analytics', { views: 0, matches: 0 }));
    const [user, setUser] = useState(() => storage.load('session', null));
    const [current, setCurrent] = useState('market'); // market | iot | dashboard | auth
    const [toasts, setToasts] = useState([]);
    const [modalProduct, setModalProduct] = useState(null);

    // persist whenever these change
    useEffect(()=> storage.save('products', products), [products]);
    useEffect(()=> storage.save('users', users), [users]);
    useEffect(()=> storage.save('orders', orders), [orders]);
    useEffect(()=> storage.save('analytics', analytics), [analytics]);
    useEffect(()=> storage.save('session', user), [user]);

    // simple toast helper
    function pushToast(t){
      const id = uid('t');
      setToasts(ts => [{ id, ...t }, ...ts].slice(0,6));
      // auto remove
      setTimeout(()=> setToasts(ts => ts.filter(x=>x.id !== id)), 9000);
    }
    function removeToast(id){ setToasts(ts => ts.filter(t=>t.id !== id)); }

    function signout(){ setUser(null); setCurrent('market'); }

    // add product
    function handleAddProduct(p){
      setProducts(ps => [p, ...ps]);
      setAnalytics(a => ({ ...a, matches: a.matches + 1 })); // demo: increment matches for visibility
      pushToast({ title: 'Product listed', msg: `${p.title} has been added.`});
    }

    // simulate immediate sensor reading change and spoilage detection
    function simulateSensor(productId){
      setProducts(ps => ps.map(p => {
        if(p.id !== productId) return p;
        // bump temp/humidity artificially to trigger
        const newTemp = (p.sensor?.temp ?? 25) + (Math.random()*6 + 3); // +3..+9
        const newHum = (p.sensor?.humidity ?? 70) + (Math.random()*6 + 3);
        const spoil = newTemp >= (p.sensor.temp || 30) || newHum >= (p.sensor.humidity || 85);
        if(spoil) pushToast({ title: 'Spoilage Alert', msg: `${p.title} flagged (T:${newTemp.toFixed(1)}°C, H:${newHum.toFixed(0)}%)` });
        return { ...p, sensor: { temp: Math.round(newTemp*10)/10, humidity: Math.round(newHum) }, spoilage: spoil };
      }));
    }

    // update sensor from IoT monitor
    function updateSensorState(productId, sensor){
      setProducts(ps => ps.map(p => {
        if(p.id !== productId) return p;
        const spoil = sensor.temp >= (p.sensor.temp || 30) || sensor.humidity >= (p.sensor.humidity || 85);
        if(spoil) pushToast({ title: 'IoT Alert', msg: `${p.title} may be spoiling (T:${sensor.temp}°C, H:${sensor.humidity}%)` });
        return { ...p, sensor: { ...p.sensor, ...sensor }, spoilage: spoil };
      }));
    }

    function handleViewProduct(p){
      setModalProduct(p);
    }

    // buyer initiates purchase
    function handleBuy(product){
      // increment analytics
      setAnalytics(a => ({ ...a, views: a.views + 1 }));
      // if user not signed-in as buyer, ask to sign in
      if(!user || user.type !== 'buyer'){ setCurrent('auth'); pushToast({ title: 'Sign in required', msg: 'Please sign in as buyer to complete purchase.' }); return; }

      // demo gating: first 2 purchases free, third triggers payment modal
      const userOrders = orders.filter(o=>o.buyerId === user.id);
      const freeUsed = userOrders.length;
      if(freeUsed >= 2){
        // open payment modal (we use Paystack/Flutterwave)
        const proceedPaid = (method) => {
          const onSuccess = (resp) => {
            const order = { id: uid('o'), productId: product.id, buyerId: user.id, amount: product.price, method, ref: resp.reference || resp.tx_ref || 'demo_ref', createdAt: Date.now() };
            setOrders(os => [order, ...os]); pushToast({ title: 'Payment Success', msg: `Order placed for ${product.title}` });
          };
          if(method === 'paystack') payWithPaystack(product.price, user.email, onSuccess, ()=>pushToast({ title: 'Payment', msg: 'Payment cancelled' }));
          else payWithFlutterwave(product.price, user.email, onSuccess, ()=>pushToast({ title: 'Payment', msg: 'Payment cancelled' }));
        };

        // show modal asking for payment method
        const choose = confirm('You have used your 2 free purchases. Pay to continue (OK = Paystack, Cancel = Flutterwave)');
        if(choose) proceedPaid('paystack'); else proceedPaid('flutterwave');
      } else {
        // free order -> just record
        const order = { id: uid('o'), productId: product.id, buyerId: user.id, amount: 0, method: 'free', ref: 'free_' + Date.now(), createdAt: Date.now() };
        setOrders(os => [order, ...os]);
        pushToast({ title: 'Order placed', msg: `${product.title} reserved — contact farmer to arrange delivery.` });
      }
    }

    // registration / login success
    function handleLogin(u){
      setUser(u);
      pushToast({ title: 'Welcome', msg: `Signed in as ${u.name}` });
      setCurrent(u.type === 'farmer' ? 'dashboard' : 'market');
    }

    return (
      <div className="min-h-screen flex flex-col">
        <Header current={current} setCurrent={setCurrent} user={user} signout={signout} />
        <main className="flex-1 bg-gray-50">
          {/* routes */}
          {current === 'auth' && <div className="max-w-5xl mx-auto p-6"><Auth onLogin={handleLogin} /></div>}

          {current === 'market' && (
            <Marketplace
              products={products}
              onBuy={handleBuy}
              onView={handleViewProduct}
              query={''}
              setQuery={()=>{}}
              filters={{}}
              setFilters={()=>{}}
            />
          )}

          {current === 'dashboard' && (
            user && user.type === 'farmer' ? (
              <DashboardArea user={user} products={products} onAddProduct={handleAddProduct} onSimulateSensor={simulateSensor} analytics={analytics} />
            ) : (
              <div className="max-w-4xl mx-auto p-6">
                <div className="bg-white p-6 rounded shadow text-center">
                  <div className="text-lg font-semibold">Farmer Dashboard</div>
                  <div className="text-sm text-gray-600 mt-2">Sign in as a farmer to manage listings.</div>
                </div>
              </div>
            )
          )}

          {current === 'iot' && <IoTMonitor products={products} updateSensorState={updateSensorState} sendToast={pushToast} />}

        </main>

        <footer className="bg-white text-xs text-gray-600 p-4 text-center">
          AgriLink360 • Connect farmers & buyers • IoT spoilage detection (demo)
        </footer>

        <ProductModal product={modalProduct} close={()=>setModalProduct(null)} onBuy={handleBuy} />

        <Toast items={toasts} remove={removeToast} />
      </div>
    );
  }

  // render
  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>


