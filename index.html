<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriLink360 — Marketplace</title>
  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui; }
    .fade-enter { opacity: 0; transform: translateY(6px); }
    .fade-enter-active { opacity: 1; transform: translateY(0); transition: all 180ms ease-out; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- App Logic -->
  <script type="text/babel">
  const { useState, useEffect } = React;

  /******** Mock Data ********/
  const STATES = ["Lagos", "Abuja", "Kano", "Kaduna", "Enugu", "Port Harcourt"];
  const INITIAL_PRODUCTS = [
    { id: 1, crop: "Maize", quantity: "100kg", location: "Lagos", price: "$50", desc: "Fresh yellow maize", sensor: "OK" },
    { id: 2, crop: "Tomatoes", quantity: "200kg", location: "Abuja", price: "$80", desc: "Ripe tomatoes", sensor: "OK" }
  ];

  /******** Header ********/
  function Header({ current, setCurrent, user, signout }) {
    return (
      <header className="bg-white shadow p-4 flex justify-between items-center">
        <h1 className="text-lg font-bold text-green-700">AgriLink360</h1>
        <nav className="space-x-4 text-sm">
          <button onClick={() => setCurrent("market")}>Marketplace</button>
          <button onClick={() => setCurrent("dashboard")}>Dashboard</button>
          <button onClick={() => setCurrent("iot")}>IoT Monitor</button>
          {!user && <button onClick={() => setCurrent("auth")}>Login / Sign Up</button>}
          {user && <button onClick={signout} className="text-red-600">Sign out</button>}
        </nav>
      </header>
    );
  }

  /******** Auth ********/
  function Auth({ onLogin }) {
    const [mode, setMode] = useState("login");
    const [form, setForm] = useState({ email:"", password:"", type:"farmer" });

    function handleSubmit(e){
      e.preventDefault();
      if(mode==="register"){
        localStorage.setItem("user:"+form.email, JSON.stringify(form));
        alert("Account created! Now sign in.");
        setMode("login");
      } else {
        const saved = localStorage.getItem("user:"+form.email);
        if(saved){
          const u = JSON.parse(saved);
          if(u.password === form.password){
            onLogin(u);
          } else alert("Wrong password");
        } else alert("No account found");
      }
    }

    return (
      <div className="max-w-md mx-auto p-6 bg-white shadow rounded mt-10">
        <h2 className="text-lg font-bold mb-4">{mode==="login"?"Sign In":"Register"}</h2>
        <form onSubmit={handleSubmit} className="space-y-3">
          <input type="email" placeholder="Email" className="w-full border p-2 rounded"
            value={form.email} onChange={e=>setForm({...form,email:e.target.value})}/>
          <input type="password" placeholder="Password" className="w-full border p-2 rounded"
            value={form.password} onChange={e=>setForm({...form,password:e.target.value})}/>
          {mode==="register" && (
            <select className="w-full border p-2 rounded"
              value={form.type} onChange={e=>setForm({...form,type:e.target.value})}>
              <option value="farmer">Farmer</option>
              <option value="buyer">Buyer</option>
            </select>
          )}
          <button className="w-full bg-green-600 text-white p-2 rounded">
            {mode==="login"?"Login":"Register"}
          </button>
        </form>
        <div className="mt-3 text-sm text-center">
          {mode==="login" ? (
            <button onClick={()=>setMode("register")} className="text-green-700">Need an account?</button>
          ) : (
            <button onClick={()=>setMode("login")} className="text-green-700">Already have an account?</button>
          )}
        </div>
      </div>
    );
  }

  /******** Marketplace ********/
  function Marketplace({ products, query, setQuery, filters, setFilters, onBuy }) {
    const filtered = products.filter(p =>
      p.crop.toLowerCase().includes(query.toLowerCase()) &&
      (!filters.location || p.location===filters.location)
    );

    return (
      <div className="max-w-6xl mx-auto p-6">
        <h2 className="text-xl font-bold mb-4">Marketplace</h2>
        <div className="flex space-x-2 mb-4">
          <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search products..."
            className="flex-1 border p-2 rounded"/>
          <select value={filters.location||""} onChange={e=>setFilters({...filters,location:e.target.value})}
            className="border p-2 rounded">
            <option value="">All Locations</option>
            {STATES.map(s=><option key={s}>{s}</option>)}
          </select>
        </div>
        <div className="grid md:grid-cols-2 gap-4">
          {filtered.map(p=>(
            <div key={p.id} className="p-4 bg-white shadow rounded">
              <h3 className="font-bold">{p.crop}</h3>
              <p>{p.desc}</p>
              <p className="text-sm text-gray-600">{p.quantity} • {p.location} • {p.price}</p>
              <button onClick={()=>onBuy(p)} className="mt-2 bg-green-600 text-white px-3 py-1 rounded">Buy</button>
            </div>
          ))}
          {filtered.length===0 && <p>No products found.</p>}
        </div>
      </div>
    );
  }

  /******** Farmer Dashboard ********/
  function FarmerDashboard({ user, products, onAddProduct, simulateSensor }) {
    const [form,setForm] = useState({ crop:"", quantity:"", location:"", price:"", desc:"" });

    function submit(e){
      e.preventDefault();
      onAddProduct(form);
      setForm({ crop:"", quantity:"", location:"", price:"", desc:"" });
    }

    return (
      <div className="max-w-5xl mx-auto p-6">
        <h2 className="text-xl font-bold mb-4">Farmer Dashboard</h2>
        <form onSubmit={submit} className="grid gap-2 mb-6">
          <input placeholder="Crop" value={form.crop} onChange={e=>setForm({...form,crop:e.target.value})} className="border p-2 rounded"/>
          <input placeholder="Quantity" value={form.quantity} onChange={e=>setForm({...form,quantity:e.target.value})} className="border p-2 rounded"/>
          <select value={form.location} onChange={e=>setForm({...form,location:e.target.value})} className="border p-2 rounded">
            <option value="">Select Location</option>
            {STATES.map(s=><option key={s}>{s}</option>)}
          </select>
          <input placeholder="Price" value={form.price} onChange={e=>setForm({...form,price:e.target.value})} className="border p-2 rounded"/>
          <textarea placeholder="Description" value={form.desc} onChange={e=>setForm({...form,desc:e.target.value})} className="border p-2 rounded"/>
          <button className="bg-green-700 text-white p-2 rounded">Add Product</button>
        </form>

        <h3 className="font-semibold mb-2">My Products</h3>
        <ul className="space-y-2">
          {products.filter(p=>p.owner===user.email).map(p=>(
            <li key={p.id} className="p-3 bg-white shadow rounded flex justify-between items-center">
              <span>{p.crop} — {p.quantity} — {p.location}</span>
              <button onClick={()=>simulateSensor(p)} className="text-sm text-red-600">Simulate Spoilage</button>
            </li>
          ))}
        </ul>
      </div>
    );
  }

  /******** IoT Monitor ********/
  function IoTMonitor({ products }) {
    return (
      <div className="max-w-5xl mx-auto p-6">
        <h2 className="text-xl font-bold mb-4">IoT Monitor</h2>
        <ul className="space-y-2">
          {products.map(p=>(
            <li key={p.id} className="p-3 bg-white shadow rounded">
              {p.crop} ({p.location}) — <span className={p.sensor==="OK"?"text-green-600":"text-red-600"}>{p.sensor}</span>
            </li>
          ))}
        </ul>
      </div>
    );
  }

  /******** Main App ********/
  function App(){
    const [current,setCurrent] = useState("market");
    const [user,setUser] = useState(null);
    const [products,setProducts] = useState(INITIAL_PRODUCTS);
    const [query,setQuery] = useState('');
    const [filters,setFilters] = useState({});

    function handleLogin(u){ setUser(u); setCurrent("market"); }
    function signout(){ setUser(null); setCurrent("auth"); }

    function handleAddProduct(form){
      const newP = { id:Date.now(), ...form, owner:user.email, sensor:"OK" };
      setProducts([...products,newP]);
    }
    function handleBuy(p){ alert("Buying "+p.crop+" from "+p.location); }
    function simulateSensor(p){
      setProducts(products.map(x=>x.id===p.id?{...x,sensor:"Spoilage Risk"}:x));
      alert("⚠️ IoT Alert: Spoilage risk for "+p.crop+"!");
    }

    return (
      <div className="min-h-screen flex flex-col">
        <Header current={current} setCurrent={setCurrent} user={user} signout={signout}/>
        <main className="flex-1">
          {current==="auth" && <Auth onLogin={handleLogin}/>}
          {current==="market" && <Marketplace products={products} query={query} setQuery={setQuery} filters={filters} setFilters={setFilters} onBuy={handleBuy}/>}
          {current==="dashboard" && user && user.type==="farmer" && <FarmerDashboard user={user} products={products} onAddProduct={handleAddProduct} simulateSensor={simulateSensor}/>}
          {current==="iot" && <IoTMonitor products={products}/>}
        </main>
        <footer className="p-4 text-center text-xs text-gray-500">AgriLink360 — Hackathon Demo</footer>
      </div>
    );
  }

  ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
